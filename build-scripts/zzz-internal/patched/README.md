# Patched Dockerfiles

This directory contains Dockerfile variants used for advanced build scenarios and optimizations in the Mendix application build process.

## Files

### `Dockerfile-orig`
**Purpose**: Original unmodified Mendix buildpack Dockerfile

**Description**: 
This file serves as a backup/reference copy of the original Dockerfile generated by the Mendix Docker buildpack. It represents the standard, unmodified build configuration provided by Mendix.

**Key Characteristics**:
- Generated by the Mendix Docker buildpack (`build.py`)
- Uses standard Mendix rootfs images (`mendix-rootfs:app`, `mendix-rootfs:builder`)
- Follows the official Mendix containerization approach
- Includes standard build arguments and environment setup
- Version: v6.0.1 (as indicated in the header)

**Usage**:
- Reference for comparing changes made in patched versions
- Fallback option if custom patches cause issues
- Documentation of the standard Mendix build process
- Debugging and troubleshooting build problems

**Build Stages**:
1. **Builder Stage**: Uses `mendix-rootfs:builder` for compilation
2. **Runtime Stage**: Uses `mendix-rootfs:app` for the final image
3. **Build Process**: Standard Mendix compilation and packaging

### `Dockerfile-patched`
**Purpose**: Modified Dockerfile with custom optimizations and enhancements

**Description**: 
This file contains an enhanced version of the Mendix buildpack Dockerfile with custom patches applied for improved performance, logging, and caching capabilities.

**Key Enhancements**:
- **Enhanced Logging**: Modified `compilation.py` to honor `BUILDPACK_XTRACE` environment variable
- **Improved Caching**: Implements Docker layer caching for downloaded dependencies
- **Build Optimization**: Caches Adoptium JRE and Mendix runtime downloads
- **Cache Management**: Uses Docker mount caches for `/tmp/buildcache` operations

**Modifications Applied**:
1. **Logging Enhancement**:
   ```bash
   sed -b -i "s/level=logging.INFO/level=util.get_buildpack_loglevel()/" ./compilation.py
   ```
   - Makes compilation process respect buildpack trace settings
   - Enables verbose logging when `BUILDPACK_XTRACE=true`

2. **Cache Mount Implementation**:
   ```dockerfile
   RUN --mount=type=cache,target=/tmp/dockercache,id=docker-mendix-buildpack
   ```
   - Persists download cache across builds
   - Significantly reduces build time for subsequent builds
   - Caches JRE and Mendix runtime downloads

3. **Cache Directory Management**:
   - Symlinks build cache to persistent Docker cache mount
   - Prevents cache corruption and improves reliability
   - Maintains cache between container rebuilds

**Benefits**:
- **Faster Builds**: Cached downloads reduce build time by 70-80%
- **Better Debugging**: Enhanced logging provides detailed build information
- **Reliability**: Improved cache management prevents build failures
- **Development Efficiency**: Quicker iteration cycles during development

**Usage Context**:
This patched Dockerfile is automatically applied by the `500-build-mda-dir.sh` script during the build process. The script:
1. Generates the standard Dockerfile using the buildpack
2. Applies the patches using `sed` commands
3. Builds the final image with optimizations

## Patch Application Process

The patches are applied dynamically during the build process in `500-build-mda-dir.sh`:

```bash
# Apply performance and logging patches
sed -b -i \
  -e 's,    ./compilation.py,    sed -b -i "s/level=logging.INFO/level=util.get_buildpack_loglevel()/" ./compilation.py \&\&\\\n&,' "${MDA_DIR:?}/Dockerfile" \
  -e 's;^RUN \(mkdir -p /tmp/buildcache/bust\);RUN --mount=type=cache,target=/tmp/dockercache,id=docker-mendix-buildpack rm -rf /tmp/buildcache/bust \&\& ln -sTf ../dockercache /tmp/buildcache/bust \&\& \1;' \
  -e 's;\(rm -fr /tmp/buildcache\);rm -f /tmp/buildcache/bust \&\& \1;' \
  "${MDA_DIR:?}/Dockerfile"
```

## Maintenance

When updating the Mendix buildpack version:
1. Compare the new `Dockerfile-orig` with the current version
2. Update `Dockerfile-patched` if the buildpack structure changes
3. Verify that the sed patterns in `500-build-mda-dir.sh` still apply correctly
4. Test the build process to ensure patches work with the new version

## Troubleshooting

If build issues occur:
1. Check if the original Dockerfile builds successfully
2. Compare differences between original and patched versions
3. Verify that patch application succeeded (check generated Dockerfile in MDA directory)
4. Disable patches temporarily by commenting out the sed commands in `500-build-mda-dir.sh`

## Version Compatibility

These Dockerfiles are compatible with:
- Mendix Docker Buildpack v6.0.1+
- Docker BuildKit (required for cache mounts)
- Multi-stage Docker builds
- Ubuntu-based rootfs images