# Internal Build System Components

This directory contains the core internal components of the build system, including Docker configurations, shell scripts, and Docker Compose orchestration files.

## Files

### Docker Compose Files

#### `100-build-with-compose.yml`
**Purpose**: Docker Compose configuration for the build process

**Description**: 
Defines the builder service that:
- Creates a temporary Ubuntu-based container with Git and Python
- Mounts the Docker socket for building images within the container
- Executes the MDA build process using the Mendix buildpack
- Sets up the working directory and environment variables for the build

**Key Configuration**:
- Base Image: `ghcr.io/catthehacker/ubuntu:act-latest`
- Container Name: `testuniqueviolation-builder`
- Output Image Tag: `testuniqueviolation-app`
- Docker Socket: Mounted for Docker-in-Docker operations

#### `900-run-compose.yml`
**Purpose**: Docker Compose configuration for running the complete application stack

**Description**:
Orchestrates the runtime environment with:
- PostgreSQL database service with health checks
- Mendix application service with proper dependencies
- Custom network configuration for service communication
- Resource limits and port mappings

**Services**:
- **postgres**: PostgreSQL 15+ database server
  - Database: `testuniqueviolation`
  - User/Password: `testuniqueviolation`
  - Port: 4079 (host) â†’ 5432 (container)
  - Memory limit: 2GB
- **app0**: Main Mendix application
  - Depends on healthy PostgreSQL service
  - Uses the built `testuniqueviolation-app` image

### Docker Files

#### `100-run-docker-mendix-buildpack.dockerfile`
**Purpose**: Dockerfile for creating the build environment

**Description**:
Multi-stage Dockerfile that:
- Uses Ubuntu act-runner as base (includes Git, Python, Docker)
- Clones the Mendix Docker buildpack from GitHub
- Sets up the build environment variables and paths
- Copies the project source code into the container

**Environment Variables**:
- `BPK_SCM_URL`: Mendix buildpack repository URL
- `BPK_SCM_REV`: Specific commit/tag of the buildpack to use
- `BPK_DIR`: Directory where buildpack is cloned
- `MPR_DIR`: Directory containing the Mendix project source
- `MDA_DIR`: Output directory for the deployment archive

#### `100-run-docker-mendix-buildpack.dockerfile.dockerignore`
**Purpose**: Docker build context exclusion rules

**Description**:
Specifies files and directories to exclude from the Docker build context:
- Version control files (`.git`, `.gitignore`)
- IDE configurations (`.idea`, `.vscode`)
- Build artifacts and caches
- Temporary and lock files
- Platform-specific files (`.bat` files)
- Compiled theme files and vendor libraries

### Shell Scripts

#### `100-clone-docker-mendix-buildpack.sh`
**Purpose**: Downloads and sets up the Mendix Docker buildpack

**Description**:
Bash script that:
- Creates a fresh Git repository in the buildpack directory
- Adds the Mendix buildpack repository as origin
- Fetches the specific commit/branch specified in `BPK_SCM_REV`
- Handles both shallow and full clones based on availability
- Checks out the desired revision for building

**Features**:
- Optimized fetching (shallow clone when possible)
- Fallback to full fetch for abbreviated commit hashes
- Proper error handling and pipeline safety

#### `500-build-mda-dir.sh`
**Purpose**: Executes the MDA (Mendix Deployment Archive) build process

**Description**:
Core build script that:
- Builds required Mendix rootfs images (app and builder)
- Executes the buildpack's build process to create MDA
- Applies performance patches to the generated Dockerfile
- Builds the final application Docker image
- Implements caching optimizations for faster subsequent builds

**Key Operations**:
- Rootfs image preparation (`mendix-rootfs:app`, `mendix-rootfs:builder`)
- MDA generation using `build.py --source --destination build-mda-dir`
- Dockerfile patching for improved logging and caching
- Final application image build with optimizations

**Patches Applied**:
- Enhanced logging support (honors `BUILDPACK_XTRACE`)
- Docker layer caching for JRE and Mendix runtime downloads
- Build cache management optimizations

## Subdirectories

### `patched/`
Contains Dockerfile variants for advanced build scenarios:

#### `Dockerfile-orig`
**Purpose**: Original unmodified Mendix buildpack Dockerfile

**Description**: 
Backup of the original Dockerfile generated by the Mendix buildpack, used for:
- Reference and comparison purposes
- Debugging build issues
- Understanding buildpack changes over time

#### `Dockerfile-patched`
**Purpose**: Modified Dockerfile with custom optimizations

**Description**:
Enhanced version of the buildpack Dockerfile with:
- Custom build optimizations
- Additional logging capabilities
- Performance improvements
- Cache management enhancements

## Build Process Flow

1. **Environment Setup**: `100-build-with-compose.yml` creates builder container
2. **Buildpack Download**: `100-clone-docker-mendix-buildpack.sh` fetches buildpack
3. **MDA Generation**: `500-build-mda-dir.sh` creates deployment archive
4. **Image Building**: Docker builds final application image
5. **Runtime**: `900-run-compose.yml` orchestrates application stack

## Configuration

### Build-time Variables
- `BUILDPACK_XTRACE`: Enable verbose buildpack logging
- `BUILDKIT_PROGRESS`: Control Docker build progress output
- `APP_TAG`: Tag for the final application image

### Runtime Variables
- `POSTGRES_DB/USER/PASSWORD`: Database configuration
- Container resource limits and networking settings

## Dependencies

- Docker Engine/Desktop
- Internet access for downloading:
  - Base Ubuntu image
  - Mendix Docker buildpack
  - PostgreSQL image
  - Java runtime and Mendix runtime downloads